#include "eval.h"


const int16_t piece_values[] = {
    //Black pieces (16-23)
    0, //0 is the empty square
    0, //1 is the white pawn
    -100, //2 is the black pawn
    -320, //3 is the black knight
    MATE_SCORE - 1, //4 is the black king (extremely high value, more than the mate score)
    -330, //5 is the black bishop
    -500, //6 is the black rook
    -900, //7 is the black queen
    //White pieces (8-15)
    0, //0 is the empty square
    100, //1 is the white pawn
    0, //2 is the black pawn
    320, //3 is the white knight
    1 - MATE_SCORE, //4 is the white king (extremely high value, more than the mate score)
    330, //5 is the white bishop
    500, //6 is the white rook
    900, //7 is the white queen
};


//On every PSQT, the White side is on the left, and the Black side is on the top.
const int8_t PAWN_PSQT[] = {
      0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
     50, 50, 50, 50, 50, 50, 50, 50, -5,-10,-10, 20, 20,-10,-10, -5,
     10, 10, 20, 30, 30, 20, 10, 10, -5,  5, 10,  0,  0, 10,  5, -5,
      5,  5, 10, 25, 25, 10,  5,  5,  0,  0,  0,-20,-20,  0,  0,  0,
      0,  0,  0, 20, 20,  0,  0,  0, -5, -5,-10,-25,-25,-10, -5, -5,
      5, -5,-10,  0,  0,-10, -5,  5,-10,-10,-20,-30,-30,-20,-10,-10,
      5, 10, 10,-20,-20, 10, 10,  5,-50,-50,-50,-50,-50,-50,-50,-50,
      0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
};

const int8_t KNIGHT_PSQT[] = {
    -50,-40,-30,-30,-30,-30,-40,-50, 50, 40, 30, 30, 30, 30, 40, 50,
    -40,-20,  0,  0,  0,  0,-20,-40, 40, 20,  0, -5, -5,  0, 20, 40,
    -30,  0, 10, 15, 15, 10,  0,-30, 30, -5,-10,-15,-15,-10, -5, 30,
    -30,  5, 15, 20, 20, 15,  5,-30, 30,  0,-15,-20,-20,-15,  0, 30,
    -30,  0, 15, 20, 20, 15,  0,-30, 30, -5,-15,-20,-20,-15, -5, 30,
    -30,  5, 10, 15, 15, 10,  5,-30, 30,  0,-10,-15,-15,-10,  0, 30,
    -40,-20,  0,  5,  5,  0,-20,-40, 40, 20,  0,  0,  0,  0, 20, 40,
    -50,-40,-30,-30,-30,-30,-40,-50, 50, 40, 30, 30, 30, 30, 40, 50,
};

const int8_t BISHOP_PSQT[] = {
    -20,-10,-10,-10,-10,-10,-10,-20, 20, 10, 10, 10, 10, 10, 10, 20,
    -10,  0,  0,  0,  0,  0,  0,-10, 10, -5,  0,  0,  0,  0, -5, 10,
    -10,  0,  5, 10, 10,  5,  0,-10, 10,-10,-10,-10,-10,-10,-10, 10,
    -10,  5,  5, 10, 10,  5,  5,-10, 10,  0,-10,-10,-10,-10,  0, 10,
    -10,  0, 10, 10, 10, 10,  0,-10, 10, -5, -5,-10,-10, -5, -5, 10,
    -10, 10, 10, 10, 10, 10, 10,-10, 10,  0, -5,-10,-10, -5,  0, 10,
    -10,  5,  0,  0,  0,  0,  5,-10, 10,  0,  0,  0,  0,  0,  0, 10,
    -20,-10,-10,-10,-10,-10,-10,-20, 20, 10, 10, 10, 10, 10, 10, 20,
};

const int8_t ROOK_PSQT[] = {
      0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, -5, -5,  0,  0,  0,
      5, 10, 10, 10, 10, 10, 10,  5,  5,  0,  0,  0,  0,  0,  0,  5,
     -5,  0,  0,  0,  0,  0,  0, -5,  5,  0,  0,  0,  0,  0,  0,  5,
     -5,  0,  0,  0,  0,  0,  0, -5,  5,  0,  0,  0,  0,  0,  0,  5,
     -5,  0,  0,  0,  0,  0,  0, -5,  5,  0,  0,  0,  0,  0,  0,  5,
     -5,  0,  0,  0,  0,  0,  0, -5,  5,  0,  0,  0,  0,  0,  0,  5,
     -5,  0,  0,  0,  0,  0,  0, -5, -5,-10,-10,-10,-10,-10,-10, -5,
      0,  0,  0,  5,  5,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
};

const int8_t QUEEN_PSQT[] = {
    -20,-10,-10, -5, -5,-10,-10,-20, 20, 10, 10,  5,  5, 10, 10, 20,
    -10,  0,  0,  0,  0,  0,  0,-10, 10,  0, -5,  0,  0,  0,  0, 10,
    -10,  0,  5,  5,  5,  5,  0,-10, 10, -5, -5, -5, -5, -5,  0, 10,
     -5,  0,  5,  5,  5,  5,  0, -5,  0,  0, -5, -5, -5, -5,  0,  5,
      0,  0,  5,  5,  5,  5,  0, -5,  5,  0, -5, -5, -5, -5,  0,  5,
    -10,  5,  5,  5,  5,  5,  0,-10, 10,  0, -5, -5, -5, -5,  0, 10,
    -10,  0,  5,  0,  0,  0,  0,-10, 10,  0,  0,  0,  0,  0,  0, 10,
    -20,-10,-10, -5, -5,-10,-10,-20, 20, 10, 10,  5,  5, 10, 10, 20,
};



const int8_t MG_KING_PSQT[] = {
    -30,-40,-40,-50,-50,-40,-40,-30,-20,-30,  0,  0,  0,  0,-30,-20,
    -30,-40,-40,-50,-50,-40,-40,-30,-20,-20,  0,  0,  0,  0,-20,-20,
    -30,-40,-40,-50,-50,-40,-40,-30, 10, 20, 20, 20, 20, 20, 20, 10,
    -30,-40,-40,-50,-50,-40,-40,-30, 20, 30, 30, 40, 40, 30, 30, 20,
    -20,-30,-30,-40,-40,-30,-30,-20, 30, 40, 40, 50, 50, 40, 40, 30,
    -10,-20,-20,-20,-20,-20,-20,-10, 30, 40, 40, 50, 50, 40, 40, 30,
     20, 20,  0,  0,  0,  0, 20, 20, 30, 40, 40, 50, 50, 40, 40, 30,
     20, 30, 10,  0,  0, 10, 30, 20, 30, 40, 40, 50, 50, 40, 40, 30,
};

const int8_t EG_KING_PSQT[] = {
    -50,-40,-30,-20,-20,-30,-40,-50, 50, 30, 30, 30, 30, 30, 30, 50,
    -30,-20,-10,  0,  0,-10,-20,-30, 30, 30,  0,  0,  0,  0, 30, 30,
    -30,-10, 20, 30, 30, 20,-10,-30, 30, 10,-20,-30,-30,-20, 10, 30,
    -30,-10, 30, 40, 40, 30,-10,-30, 30, 10,-30,-40,-40,-30, 10, 30,
    -30,-10, 30, 40, 40, 30,-10,-30, 30, 10,-30,-40,-40,-30, 10, 30,
    -30,-10, 20, 30, 30, 20,-10,-30, 30, 10,-20,-30,-30,-20, 10, 30,
    -30,-30,  0,  0,  0,  0,-30,-30, 30, 20, 10,  0,  0, 10, 20, 30,
    -50,-30,-30,-30,-30,-30,-30,-50, 50, 40, 30, 20, 20, 30, 40, 50,
};


const int8_t *PSQT_MG[] = {
    nullptr,
    PAWN_PSQT,
    PAWN_PSQT,
    KNIGHT_PSQT,
    MG_KING_PSQT,
    BISHOP_PSQT,
    ROOK_PSQT,
    QUEEN_PSQT,
};

const int8_t *PSQT_EG[] = {
    nullptr,
    PAWN_PSQT,
    PAWN_PSQT,
    KNIGHT_PSQT,
    EG_KING_PSQT,
    BISHOP_PSQT,
    ROOK_PSQT,
    QUEEN_PSQT,
};


int16_t evaluate()
{
    int16_t material_psqt_sum = 0;

    uint8_t nqueens = 0;

    //endgame detection
    for (uint8_t i = 0; i < 32; i++) //count the number of queens (if there are no queens, it's an endgame; if 1 side only has a queen, its probably winning)
    {
        uint8_t sq = plist[i];
        if (sq != 0xFF && (board[sq] & PTYPE) == QUEEN) nqueens++;
    }

    //piece_values
    for (uint8_t i = 0; i < 32; i++)
    {
        uint8_t sq = plist[i];
        if (sq == 0xFF) continue; //piece has been captured

        uint8_t piece = board[sq];
        material_psqt_sum += piece_values[piece & 0x0F]; //get the piece's value and add it to the total material sum

        int8_t **psqt = (int8_t**)(nqueens ? PSQT_MG : PSQT_EG);
        material_psqt_sum += psqt[piece & PTYPE][((piece & 8) ^ 8) + sq];
    }

    return material_psqt_sum;
}
